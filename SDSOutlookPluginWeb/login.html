
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>ERP Login</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        input {
            margin-bottom: 10px;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 10px;
        }

        #result {
            margin-top: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h2 id="title">Login to ERP</h2>

    <div id="login-form">
        <input type="text" id="username" placeholder="Username" />
        <br />
        <input type="password" id="password" placeholder="Password" />
        <br />
        <button onclick="doLogin()">Login</button>
    </div>

    <div id="logged-in-section" style="display: none;">
        <p id="welcome-msg"></p>
        <button onclick="refreshTokenIfNeeded()">🔁 Refresh Token</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="result"></div>

    <script>
        // Basic encoding for light token obfuscation
        function encrypt(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function decrypt(str) {
            try {
                return decodeURIComponent(escape(atob(str)));
            } catch {
                return null;
            }
        }

        async function doLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const payload = {
                userName: username,
                password: password,
                loginRsponse: {
                    passwordRestrinctionVerifiedStatus: {
                        nbRepete: 0,
                        isVerified: true,
                        message: "Password respect requirements"
                    }
                }
            };

            try {
                const response = await fetch('https://authentication.tlc-com.com/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                const accessToken = result?.token?.access_token;
                const refreshToken = result?.token?.refresh_token;

                if (accessToken && refreshToken) {
                    const settings = Office.context?.roamingSettings;
                    if (settings) {
                        settings.set("access_token", encrypt(accessToken));
                        settings.set("refresh_token", encrypt(refreshToken));
                        settings.set("erp_username", result?.userName || username);
                        settings.saveAsync(() => {
                            showLoggedInUI(result?.userName || username);
                        });
                    }
                } else {
                    document.getElementById('result').innerText = "❌ Login Failed.";
                }
            } catch (error) {
                document.getElementById('result').innerText = "🚨 Error: " + error.message;
            }
        }

        function logout() {
            const settings = Office.context?.roamingSettings;
            if (settings) {
                settings.remove("access_token");
                settings.remove("refresh_token");
                settings.remove("erp_username");
                settings.saveAsync(() => {
                    showLoginUI();
                });
            }
        }

        function showLoginUI() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('logged-in-section').style.display = 'none';
            document.getElementById('title').innerText = "Login to ERP";
            document.getElementById('result').innerText = "";
        }

        function showLoggedInUI(username) {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('logged-in-section').style.display = 'block';
            document.getElementById('welcome-msg').innerText = `✅ You are logged in as: ${username}`;
            document.getElementById('title').innerText = "Welcome!";
            document.getElementById('result').innerText = "";
        }

        function checkLoginStatus() {
            const settings = Office.context?.roamingSettings;
            if (!settings) {
                showLoginUI();
                return;
            }

            const encryptedToken = settings.get("access_token");
            const username = settings.get("erp_username");

            if (encryptedToken && username) {
                const token = decrypt(encryptedToken);
                if (token) {
                    showLoggedInUI(username);
                } else {
                    showLoginUI();
                }
            } else {
                showLoginUI();
            }
        }

        async function refreshTokenIfNeeded() {
            const settings = Office.context?.roamingSettings;
            if (!settings) return;

            const accessEncrypted = settings.get("access_token");
            const refreshEncrypted = settings.get("refresh_token");

            const access_token = decrypt(accessEncrypted);
            const refresh_token = decrypt(refreshEncrypted);

            if (!access_token || !refresh_token) {
                document.getElementById('result').innerText = "⚠️ No valid token to refresh.";
                return;
            }

            const payload = {
                token: {
                    expires_in: 14400000,
                    access_token: access_token,
                    refresh_token: refresh_token
                }
            };

            try {
                const response = await fetch('https://authentication.tlc-com.com/auth/refresh-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const newAccess = result?.token?.access_token;
                const newRefresh = result?.token?.refresh_token;

                if (newAccess && newRefresh) {
                    settings.set("access_token", encrypt(newAccess));
                    settings.set("refresh_token", encrypt(newRefresh));
                    settings.saveAsync(() => {
                        document.getElementById('result').innerText = "✅ Token refreshed successfully!";
                    });
                } else {
                    document.getElementById('result').innerText = "❌ Refresh failed. Please log in again.";
                    logout();
                }

            } catch (err) {
                console.error("Token refresh error:", err);
                document.getElementById('result').innerText = "🚨 Error refreshing token.";
                logout();
            }
        }

        Office.onReady(() => {
            checkLoginStatus();
        });
    </script>
</body>
</html>
